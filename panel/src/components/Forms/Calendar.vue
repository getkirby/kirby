<template>
  <div class="k-calendar-input">
    <nav>
      <k-button icon="angle-left" @click="prev" />
      <span class="k-calendar-selects">
        <k-select-input
          v-model.number="view.month"
          :options="months"
          :disabled="disabled"
          :required="true"
        />
        <k-select-input
          v-model.number="view.year"
          :options="years"
          :disabled="disabled"
          :required="true"
        />
      </span>
      <k-button icon="angle-right" @click="next" />
    </nav>

    <table class="k-calendar-table">
      <thead>
        <tr>
          <th v-for="day in weekdays" :key="'weekday_' + day">{{ day }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="week in numberOfWeeks" :key="'week_' + week">
          <td
            v-for="(day, dayIndex) in days(week)"
            :key="'day_' + dayIndex"
            :aria-current="isToday(day) ? 'date' : false"
            :aria-selected="isSelected(day) ? 'date' : false"
            class="k-calendar-day"
          >
            <k-button
              v-if="day"
              :disabled="isDisabled(day)"
              @click="select(day)"
            >
              {{ day }}
            </k-button>
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td class="k-calendar-today" colspan="7">
            <k-button @click="select('today')">{{ $t("today") }}</k-button>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</template>

<script>

export default {
  props: {
    disabled: Boolean,
    max: String,
    min: String,
    multiple: Boolean,
    value: [Array, String],
  },
  data() {
    return this.toData(this.value);
  },
  computed: {
    today() {
      return this.$library.dayjs.utc();
    },
    numberOfDays() {
      return this.viewDt.daysInMonth();
    },
    numberOfWeeks() {
      return Math.ceil((this.numberOfDays + this.firstWeekday - 1) / 7);
    },
    firstWeekday() {
      const weekday = this.viewDt.day();
      return weekday > 0 ? weekday : 7;
    },
    weekdays() {
      return [
        this.$t('days.mon'),
        this.$t('days.tue'),
        this.$t('days.wed'),
        this.$t('days.thu'),
        this.$t('days.fri'),
        this.$t('days.sat'),
        this.$t('days.sun'),
      ];
    },
    monthnames() {
      return [
        this.$t('months.january'),
        this.$t('months.february'),
        this.$t('months.march'),
        this.$t('months.april'),
        this.$t('months.may'),
        this.$t('months.june'),
        this.$t('months.july'),
        this.$t('months.august'),
        this.$t('months.september'),
        this.$t('months.october'),
        this.$t('months.november'),
        this.$t('months.december'),
      ];
    },
    months() {
      var options = [];

      this.monthnames.forEach((item, index) => {
        // get date object for 1st of the month
        const date = this.toDate(1, index);

        options.push({
          value: index,
          text: item,
          disabled: date.isBefore(this.view.min, "month") ||
                    date.isAfter(this.view.max, "month")
        });
      });

      return options;
    },
    years() {
      var options = [];

      const min = this.view.min
                ? this.view.min.get("year")
                : this.view.year - 20;
      const max = this.view.max
                ? this.view.max.get("year")
                : this.view.year + 20;

      for (var x = min; x <= max; x++) {
        options.push({
          value: x,
          text: this.$helper.pad(x)
        });
      }

      return options;
    },
    viewDt() {
      const dt = `${this.view.year}-${this.view.month + 1}-01 00:00:00`;
      return this.$library.dayjs.utc(dt);
    }
  },
  watch: {
    value(value) {
      const data     = this.toData(value);
      this.datetimes = data.datetimes;
      this.view      = data.view;
    }
  },
  methods: {
    days(week) {
      let days    = [];
      const start = (week - 1) * 7 + 1;

      for (let x = start; x < start + 7; x++) {
        let day = x - (this.firstWeekday - 1);
        if (day <= 0 || day > this.numberOfDays) {
          days.push("");
        } else {
          days.push(day);
        }
      }

      return days;
    },
    isDisabled(day) {
      const date = this.toDate(day);
      return date.isBefore(this.view.min, "day") ||
             date.isAfter(this.view.max, "day");
    },
    isSelected(day) {
      if (day === "") {
        return false;
      }

      const date = this.toDate(day);
      return this.datetimes.some(current => date.isSame(current, "day"));
    },
    isToday(day) {
      return this.toDate(day).isSame(this.$library.dayjs.utc(), "day");
    },
    next() {
      let next = this.viewDt.clone().add(1, "month");
      this.show(next);
    },
    prev() {
      let prev = this.viewDt.clone().subtract(1, "month");
      this.show(prev);
    },
    mergeTime(dt1, dt2) {
      return dt1.clone().set("second", dt2.get("second"))
                        .set("minute", dt2.get("minute"))
                        .set("hour", dt2.get("hour"));
    },
    select(day) {
      if (day === "today") {
        const today = this.$library.dayjs();
        this.datetimes = [today];
        this.show(today);

      } else {
        const date = this.toDate(day);
        const reference = this.datetimes[0] || this.today;

        if (this.multiple === false) {
          this.datetimes = [this.mergeTime(date, reference)];
        } else {
          this.datetimes.push(this.mergeTime(date, reference));
        }
      }

      if (this.multiple) {
        this.$emit("input", this.datetimes.map(date => this.toISO(date)));
      } else {
        this.$emit("input", this.toISO(this.datetimes[0]));
      }
    },
    show(date) {
      this.view.year  = date.year();
      this.view.month = date.month();
    },
    toData(value) {
      const datetimes = this.toDatetimes(value);

      return {
        datetimes: datetimes,
        view: {
          month: (datetimes[0] || this.today).month(),
          year: (datetimes[0] || this.today).year(),
          min: this.min ? this.$library.dayjs.utc(this.min) : null,
          max: this.max ? this.$library.dayjs.utc(this.max) : null,
        }
      }
    },
    toDate(day, month = this.view.month, year = this.view.year) {
      return this.$library.dayjs.utc(`${year}-${month + 1}-${day} 00:00:00`);
    },
    toDatetimes(value) {
      if (!value) {
        return [];
      }

      if (typeof value === "string") {
        return [this.$library.dayjs.utc(value)];
      }

      return value.map(date => this.$library.dayjs.utc(date));
    },
    toISO(dt) {
      return dt.format("YYYY-MM-DD HH:mm:ss");
    }
  }
};
</script>

<style lang="scss">
$cell-padding: 0.25rem 0.5rem;

.k-calendar-input {
  padding: 0.5rem;
  background: $color-gray-900;
  color: $color-light;
  border-radius: $rounded-xs;
}
.k-calendar-table {
  table-layout: fixed;
  width: 100%;
  min-width: 15rem;
  padding-top: .5rem;
}

.k-calendar-input > nav {
  display: flex;
  direction: ltr;

  .k-button {
    padding: 0.5rem;
  }
}
.k-calendar-selects {
  flex-grow: 1;
  display: flex;
  align-items: center;
  justify-content: center;

  [dir="ltr"] & {
    direction: ltr;
  }

  [dir="rtl"] & {
    direction: rtl;
  }

}
.k-calendar-selects .k-select-input {
  padding: 0 0.5rem;
  font-weight: $font-normal;
  font-size: $text-sm;
}
.k-calendar-selects .k-select-input:focus-within {
  color: $color-focus-on-dark !important;
}
.k-calendar-input th {
  padding: 0.5rem 0;
  color: $color-light-grey;
  font-size: $text-xs;
  font-weight: 400;
  text-align: center;
}
.k-calendar-day .k-button {
  width: 2rem;
  height: 2rem;
  margin: 0 auto;
  color: $color-white;
  line-height: 1.75rem;
  display: flex;
  justify-content: center;
  border-radius: 50%;
  border: 2px solid transparent;
}
.k-calendar-day .k-button .k-button-text {
  opacity: 1;
}
.k-calendar-table .k-button:hover {
  color: $color-white;
}
.k-calendar-day:hover .k-button:not([data-disabled]) {
  border-color: rgba($color-white, 0.25);
}
.k-calendar-day[aria-current="date"] .k-button {
  color: $color-yellow-600;
  font-weight: 500;
}
.k-calendar-day[aria-selected="date"] .k-button {
  border-color: $color-focus-on-dark;
  color: $color-focus-on-dark;
}
.k-calendar-today {
  text-align: center;
  padding-top: .5rem;
}
.k-calendar-today .k-button {
  color: $color-focus-on-dark;
  font-size: $text-xs;
  padding: 1rem;
}
.k-calendar-today .k-button-text {
  opacity: 1;
}
</style>
